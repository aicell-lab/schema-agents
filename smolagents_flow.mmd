graph TD
    UserQuery[User Query/Task] --> InitAgent[Initialize Agent]
    InitAgent --> InitPrompt[Initialize System Prompt]
    InitPrompt --> InitMem[Initialize Memory]
    InitMem --> CheckPlanning{Is first step?}
    
    CheckPlanning -->|Yes| InitPlan[Generate Initial Plan & Facts]
    CheckPlanning -->|No| RegularStep[Process Regular Step]
    
    InitPlan --> RecordPlan[Record Plan in Memory]
    RecordPlan --> ExecuteStep[Execute Step]
    
    RegularStep --> CheckInterval{Planning interval reached?}
    CheckInterval -->|Yes| UpdatePlan[Update Plan & Facts]
    CheckInterval -->|No| ExecuteStep
    
    UpdatePlan --> RecordUpdatedPlan[Record Updated Plan]
    RecordUpdatedPlan --> ExecuteStep
    
    ExecuteStep --> ExtractAction[Extract Action & Arguments]
    ExtractAction --> ValidateAction[Validate Action]
    
    ValidateAction --> ExecuteTool[Execute Tool]
    ExecuteTool --> RecordObservation[Record Observation]
    
    RecordObservation --> CheckMaxSteps{Max steps reached?}
    CheckMaxSteps -->|No| CheckFinalAnswer{Is final answer?}
    CheckMaxSteps -->|Yes| ForceFinalAnswer[Force Final Answer]
    
    CheckFinalAnswer -->|Yes| GenerateFinalAnswer[Generate Final Answer]
    CheckFinalAnswer -->|No| CheckPlanning
    
    ForceFinalAnswer --> GenerateFinalAnswer
    GenerateFinalAnswer --> ReturnResult[Return Result]
    
    subgraph ToolExecution
    ExecuteTool --> CheckToolType{Tool Type?}
    CheckToolType -->|Standard Tool| RunStandardTool[Run Standard Tool]
    CheckToolType -->|Managed Agent| RunManagedAgent[Run Managed Agent]
    RunStandardTool --> CollectObservation[Collect Observation]
    RunManagedAgent --> CollectObservation
    CollectObservation --> HandleToolErrors[Handle Errors]
    end
    
    subgraph MemorySystem
    InitMem --> RecordMemoryStep[Record Memory Step]
    RecordPlan --> UpdateMemory[Update Memory]
    RecordObservation --> UpdateMemory
    RecordUpdatedPlan --> UpdateMemory
    end 